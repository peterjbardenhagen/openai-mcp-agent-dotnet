# yaml-language-server: $schema=https://raw.githubusercontent.com/Azure/azure-dev/main/schemas/v1.0/azure.yaml.json

name: openai-mcp-agent-dotnet

metadata:
  template: azd-init@1.15.0

services:
  mcptodo-clientapp:
    project: src/McpTodo.ClientApp
    host: containerapp
    language: dotnet
    docker:
      path: ../../Dockerfile.client
      context: ../../
      remoteBuild: true
  mcptodo-serverapp:
    project: src/McpTodo.ServerApp
    host: containerapp
    language: ts
    docker:
      path: Dockerfile
      context: .
      remoteBuild: true

hooks:
  preprovision:
    posix:
      shell: sh
      interactive: false
      continueOnError: false
      run: |
        REPOSITORY_ROOT="$(git rev-parse --show-toplevel)"
        SERVER_DIR="$REPOSITORY_ROOT/src/McpTodo.ServerApp"
        CLIENT_DIR="$REPOSITORY_ROOT/src/McpTodo.ClientApp"

        if [ -d "$SERVER_DIR" ]; then
          echo "Directory $SERVER_DIR already exists. Removing it before cloning..."
          rm -rf "$SERVER_DIR"
        fi

        git clone https://github.com/Azure-Samples/mcp-container-ts.git "$SERVER_DIR"

        cd "$SERVER_DIR"
        npm install
        npm run generate-token -- --admin
        cd "$REPOSITORY_ROOT"

        ENV_DIR="$REPOSITORY_ROOT/.azure/$(azd env get-value AZURE_ENV_NAME)"
        cat "$SERVER_DIR/.env" >> "$ENV_DIR/.env"

    windows:
      shell: pwsh
      continueOnError: false
      interactive: false
      run: |
        $REPOSITORY_ROOT = git rev-parse --show-toplevel
        $SERVER_DIR = "$REPOSITORY_ROOT/src/McpTodo.ServerApp"
        $CLIENT_DIR = "$REPOSITORY_ROOT/src/McpTodo.ClientApp"

        if (Test-Path $SERVER_DIR) {
          Write-Host "Directory $SERVER_DIR already exists. Removing it before cloning..."
          Remove-Item -Recurse -Force $SERVER_DIR
        }

        git clone https://github.com/Azure-Samples/mcp-container-ts.git "$SERVER_DIR"

        cd "$SERVER_DIR"
        npm install
        npm run generate-token -- --admin
        cd "$REPOSITORY_ROOT"

        $ENV_DIR = "$REPOSITORY_ROOT/.azure/$(azd env get-value AZURE_ENV_NAME)"
        Get-Content "$SERVER_DIR/.env" | Add-Content -Path "$ENV_DIR/.env" -Encoding utf8 -Force
